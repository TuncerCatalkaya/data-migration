@startuml
start

:Start Import Process;
:Retrieve Project ID and File Name;
:Create Scope Model;

repeat
  :Attempt Import;
  :Fetch Scope Entity;
  if (Scope is finished?) then (yes)
    :Log "Already Processed";
    stop
  else (no)
    :Check for Existing Checkpoint;
    if (Checkpoint Exists?) then (yes)
      :Set Batch Size from Checkpoint;
    else (no)
      :Set Default Batch Size;
      :Create and Save New Checkpoint;
    endif

    :Fetch S3 Object;
    :Read File Headers;

    fork
    :Process File Lines;
    repeat
      :Read Line from File;
      :Calculate Batch Index;
      if (Batch Already Processed?) then (yes)
        :Skip Batch;
      else (no)
        :Add Item to Batch;
        if (Batch Size Met?) then (yes)
          :Submit Batch for Parallel Processing;
        endif
      endif
    repeat while (More Lines)

    if (Remaining Items in Batch?) then (yes)
      :Submit Remaining Batch for Processing;
    endif
    fork again
    :Parallel Batch Processing;
    while (Active Batches > 0)
      :Wait for Active Batches;
    endwhile
    end fork

    if (All Batches Processed Successfully?) then (yes)
      :Mark Scope as Finished;
      :Log "Import Success";
      stop
    else (no)
      :Log "Retry or Fail";
      if (Max Retries Reached?) then (yes)
        :Abort Processing;
        stop
      else (no)
        :Retry Import;
      endif
    endif
  endif
repeat while (Not Success)

@enduml
